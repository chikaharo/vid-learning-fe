name: Build and Deploy Node.js to EC2

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  S3_BUCKET: huybd-vidlearning-dev-assets-us-east-1
  INSTANCE_ID: i-027af4d4132c6351e
  PROJECT_PATH: /var/www/vid-learning/vid-learning-fe

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1. Install ALL dependencies (including devDependencies like TypeScript)
      - name: Install Dependencies
        run: npm install

      # 2. Build the project (creates .next/ or build/ folder)
      - name: Build Source
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env && npm run build
          rm -rf node_modules

      - name: Zip Artifact
        run: |
          zip -r deployment-fe-package.zip .next out package.json package-lock.json

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-to-assume: arn:aws:iam::468629877310:role/huybd-vidlearning-github-role
          aws-region: us-east-1

      # 3. Copy ONLY the build artifacts and package definition
      # We do NOT copy node_modules from the runner.
      # We assume the build output is in a folder named 'dist'.
      # - name: Copy Artifacts via SCP
      #   run: |
      #     scp -r dist package.json package-lock.json ecosystem.config.js ec2-target:${{ secrets.TARGET_DIR }}

      - name: Copy to S3
        run: |
          aws s3 cp deployment-fe-package.zip s3://${{ env.S3_BUCKET }}/builds/${{ github.sha }}.zip --sse AES256

      - name: Deploy via SSM
        run: |
          aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=i-027af4d4132c6351e" \
            --parameters commands='[
              "echo Starting Deployment...",
              "export AWS_DEFAULT_REGION=${{ env.AWS_REGION }}",

              "# 1. Create directory if not exists",
              "mkdir -p ${{ env.PROJECT_PATH }}",

              "# 2. Clean the directory",
              "cd /var/www/vid-learning/vid-learning-fe && find . -mindepth 1 ! -name \".env\" -exec rm -rf {} +",

              "# 2. Download from S3",
              "su - ec2-user -c \"aws s3 cp s3://${{ env.S3_BUCKET }}/builds/${{ github.sha }}.zip /tmp/deployment.zip\"",
              
              "# 3. Unzip to target location (overwriting)",
              "unzip -o /tmp/deployment.zip -d ${{ env.PROJECT_PATH }}",
              
              "# 4. Create ENV file",
              "echo \"${{ secrets.ENV_FILE }}\" > ${{ env.PROJECT_PATH }}/.env",

              "# 5. Install Production Deps",
              "su - ec2-user -c \"cd ${{ env.PROJECT_PATH }} && npm install --production\"",

              "# 6. Restart Application with PM2",
              "if ! su - ec2-user -c \"npm list -g serve\"; then su - ec2-user -c \"npm install -g serve\"; fi",
              "su - ec2-user -c \"pm2 restart vid-learning-fe || cd ${{ env.PROJECT_PATH }} && pm2 start serve --name vid-learning-frontend -- -s out -p 3000\"",
              "su - ec2-user -c \"pm2 save\"",

              "echo Deployment Complete"
            ]'
